<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
        <link rel="stylesheet" type="text/css" href="css/styles.css"/>
    </head>
    <body class="theme_green">

        <div class="block">
            <p>Below is a button to fetch images from unsplash.it using the native webservice&cache API. The first time you will use it it will have to wait until the server responds. Next time, the data will already be in the storage so you will be able to have the cache result in an instant.</p>

            <a href="javascript:;" id="try">Ask webservice for images</a>
        </div>


        <div class="block">
            <p>You can also use some processData to treat the data on the native side if you want. For example, pick random images from the cache storage.</p>

            <div style="display:flex;">
                <a href="javascript:;" id="pick5images" style="flex:1;">Pick 5 images</a>
                <a href="javascript:;" id="pick10images" style="flex:1;">Pick 10 images</a>
            </div>
        </div>

        <div id="pageLog" class="block" style="padding:5px; background:#CCC; min-height: 40px;">



        </div>

        <div class="block">
            <p>Result images</p>

            <div id="result"></div>
        </div>


        <script type="text/javascript" src="js/zepto.min.js"></script>
        <script type="text/javascript" src="../platform/cobalt.js"></script>


        <script type="text/javascript" src="../WebServicesPlugin/cobalt.webservices.js"></script>
        <script type="text/javascript" src="js/setTimeoutWorkaround.js"></script>
        <script type="text/javascript" src="js/app.js"></script>

        <script>

            var pageLog = function (str) {
                $('#pageLog').append(str + '<br/>');
            };

            var handleCacheResults = function (data, concernedCall) {
                if (data && data.result) {
                    pageLog('STORE SUCCESS : got ' + data.result.length + ' images from the WS storage');
                    showResults(data.result);
                }
                else {
                    pageLog('STORE : Warning : got something in storage but that is NOT some images');
                }
            };

            var handleCacheErrors = function (error, concernedCall) {
                pageLog('STORE Error : ' + error);
            };

            var handleSuccess = function (data, concernedCall) {
                if (data && data.result) {
                    pageLog('SUCCESS : Unsplash.it replied with ' + data.result.length + ' images');
                    showResults(data.result);
                }
                else {
                    pageLog('ERROR : no answer from unsplash.it or data not parsed to json : ' + JSON.stringify(data))
                }
            };

            var showResults = function (results) {
                var maxDisplay = Math.min(10, results.length);
                var html = '<p>Displaying ' + maxDisplay + ' images out of ' + results.length + '</p>';

                for (var i = 0; i < maxDisplay; i++) {
                    var item = results[i];
                    html += '<img style="width:100%;" src="https://unsplash.it/256?image=' + item.id + '" /><br>';
                }

                $('#result').html(html);
            };

            Zepto(function ($) {
                cobalt.init({
                    debug: app.debug,
                    debugInBrowser: app.debugInBrowser,
                    debugInDiv: false,
                    plugins: {
                        // Same as cobalt.ws.config()
                        webservices:{
                            base: {
                                url : "https://unsplash.it/"
                            },
                            defaultParameters: {
                                errorCallback : function(data, error, concernedCall) {
                                    pageLog('WS error for call ' + concernedCall.callId + '. server response is ' +  error);
                                }
                            }
                        }
                    }
                });

                app.initPage('Webservices Plugin');

                app.touch('#try', function () {
                    $('#result').html();
                    cobalt.ws.call({
                        url: "list",
                        arguments: {},
                        storageKey: "unsplashImages:0",
                        successCallback: handleSuccess,
                        cacheCallback: handleCacheResults
                    });
                });

                app.touch('#pick5images', function () {
                    $('#result').html();
                    cobalt.ws.call({
                        storageKey: "unsplashImages:0",
                        processData: { "count" : 5 }, // Optional native side filtering / sorting
                        cacheCallback: handleCacheResults,
                        cacheError: handleCacheErrors
                    })
                });

                app.touch('#pick10images', function () {
                    $('#result').html();
                    cobalt.ws.call({
                        storageKey: "unsplashImages:0",
                        processData: { "count": 10 }, // Optional native side filtering / sorting
                        cacheCallback: handleCacheResults,
                        cacheError: handleCacheErrors
                    });
                });
            });

        </script>

    </body>
</html>
